<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Task Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
      (function(){var t=localStorage.getItem("taskManagerTheme");if(t==="dark")document.documentElement.setAttribute("data-theme","dark");else if(!t&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)document.documentElement.setAttribute("data-theme","dark");var s=localStorage.getItem("taskManagerSprintMode");if(s==="1")document.body.classList.add("sprint-mode-active");})();
    </script>
</head>
<body>
    <div class="app-layout">
        <header class="app-header" role="banner">
            <span class="app-header-title">Task Manager</span>
            <div class="header-actions">
                <button type="button" class="sprint-select-toggle" id="sprint-select-toggle" title="Select which tasks are in the sprint" aria-pressed="false" aria-label="Select sprint tasks">
                    <span class="sprint-select-icon" aria-hidden="true">‚úì</span>
                    <span class="sprint-select-label">Select sprint</span>
                </button>
                <button type="button" class="sprint-mode-toggle" id="sprint-mode-toggle" title="Show only sprint tasks" aria-pressed="false" aria-label="Sprint Mode">
                    <span class="sprint-mode-icon" aria-hidden="true">üèÉ</span>
                    <span class="sprint-mode-label">Sprint</span>
                </button>
                <button type="button" class="theme-toggle" id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
                    <span class="theme-toggle-icon theme-icon-light" aria-hidden="true">‚òÄ</span>
                    <span class="theme-toggle-icon theme-icon-dark" aria-hidden="true">‚òΩ</span>
                </button>
            </div>
        </header>
        <div class="app-columns">
        <aside class="column-left">
            <div class="column-left-inner">
                <h1 class="app-title">Developer Task Manager</h1>
                <p class="app-subtitle">Add and track your tasks locally.</p>
                <section class="add-task-section" aria-labelledby="add-task-heading">
                    <h2 id="add-task-heading" class="add-task-heading">Add Task</h2>
                    <form method="post" action="/" class="add-form">
                        <input type="text" name="title" placeholder="Task title..." required autofocus>
                        <textarea name="description" placeholder="Description (optional)" rows="2"></textarea>
                        <div class="form-row">
                            <div class="type-picker" id="type-picker">
                                <span class="label-text">Type</span>
                                <input type="hidden" name="task_type" id="task_type_input" value="coding">
                                <button type="button" class="type-picker-btn" id="type-picker-btn" aria-haspopup="listbox" aria-expanded="false" aria-label="Select task type">
                                    <span class="type-swatch type-swatch--coding" id="type-picker-swatch"></span>
                                    <span id="type-picker-label">coding</span>
                                </button>
                                <div class="type-picker-dropdown" role="listbox" id="type-picker-dropdown" aria-hidden="true">
                                    {% for tt in task_types %}
                                    <button type="button" class="type-picker-option" role="option" data-value="{{ tt }}" data-label="{{ tt }}">
                                        <span class="type-swatch type-swatch--{{ tt }}"></span>
                                        <span>{{ tt }}</span>
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            <label>
                                <span class="label-text">Status</span>
                                <select name="status">
                                    {% for s in statuses %}
                                    <option value="{{ s }}">{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                            <label>
                                <span class="label-text">Due date</span>
                                <input type="date" name="due_date" class="add-form-date">
                            </label>
                        </div>
                        <label class="add-form-code-link-wrap">
                            <span class="label-text">Code link</span>
                            <input type="text" name="code_link" class="add-form-code-link" placeholder="File path, module, or GitHub/GitLab URL‚Ä¶">
                        </label>
                        <label class="add-form-code-snippet-wrap">
                            <span class="label-text">Code snippet (optional)</span>
                            <textarea name="code_snippet" class="add-form-code-snippet" placeholder="Paste a short code snippet‚Ä¶" rows="4"></textarea>
                        </label>
                        <label class="add-form-blocked-wrap">
                            <span class="add-form-checkbox-row">
                                <input type="checkbox" name="blocked" value="1" id="add-form-blocked" class="add-form-blocked-cb">
                                <span class="label-text">Blocked</span>
                            </span>
                            <input type="text" name="blocking_reason" class="add-form-blocking-reason" placeholder="Blocking reason (optional)" aria-label="Blocking reason">
                        </label>
                        <button type="submit">Add Task</button>
                    </form>
                </section>
            </div>
        </aside>

        <main class="column-main">
            <div class="column-main-inner">
                {% if tasks %}
                {% if timeline_tasks %}
                <section class="timeline-wrap">
                    <h2 class="timeline-title">By due date</h2>
                    <div class="timeline" role="list">
                        {% for t in timeline_tasks %}
                        <a href="#" class="timeline-item" data-task-id="{{ t.id }}" data-in-sprint="{{ 'true' if t.in_sprint else 'false' }}" title="{{ t.title }} ‚Äì {{ t.due_date }}">
                            <span class="timeline-item-title">{{ t.title }}</span>
                            <span class="timeline-item-date">{{ t.due_date }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
                <div class="board-search-wrap">
                    <input type="search" id="board-search" class="board-search" placeholder="Search by title or type‚Ä¶" aria-label="Search tasks">
                </div>
                {% if blocked_tasks %}
                <section class="blocked-section" aria-labelledby="blocked-heading">
                    <h2 id="blocked-heading" class="blocked-section-title">Blocked</h2>
                    <ul class="blocked-list" role="list">
                        {% for task in blocked_tasks %}
                        {% set due = task.due_date or '' %}
                        {% set is_overdue = due and due < today_iso %}
                        {% set is_due_soon = due and not is_overdue and due <= due_soon_end_iso %}
                        <li class="card card--blocked card--{{ task.task_type }}{% if is_overdue %} task-overdue{% elif is_due_soon %} task-due-soon{% endif %}" draggable="true" data-task-id="{{ task.id }}" data-in-sprint="{{ 'true' if task.in_sprint else 'false' }}">
                            <div class="card-body">
                                <div class="card-body-header">
                                    <label class="card-sprint-checkbox sprint-selection-only" aria-hidden="true" title="Include in sprint">
                                        <input type="checkbox" class="card-in-sprint-cb" data-task-id="{{ task.id }}" {% if task.in_sprint %}checked{% endif %}>
                                        <span class="sprint-cb-label">Sprint</span>
                                    </label>
                                    <button type="button" class="card-collapse-toggle" title="Expand or collapse" aria-expanded="true" aria-label="Collapse card">‚ñæ</button>
                                    <span class="task-title">{{ task.title }}</span>
                                </div>
                                <div class="card-body-detail">
                                    {% if task.blocking_reason %}
                                    <p class="task-blocking-reason"><span class="blocked-badge">Blocked</span> {{ task.blocking_reason|e }}</p>
                                    {% else %}
                                    <p class="task-blocking-reason"><span class="blocked-badge">Blocked</span></p>
                                    {% endif %}
                                    {% if task.description %}
                                    <p class="task-description">{{ task.description }}</p>
                                    {% endif %}
                                    <div class="task-meta-row">
                                        <span class="badge badge-type badge-type--{{ task.task_type }}">{{ task.task_type }}</span>
                                        <span class="task-status-muted">{{ task.status }}</span>
                                        {% if due %}
                                        <span class="task-due-date" title="Due {{ due }}">üìÖ {{ due }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <form method="post" action="{{ url_for('update_status', task_id=task.id) }}" class="status-form">
                                    <select name="status" onchange="this.form.submit()">
                                        {% for s in statuses %}
                                        <option value="{{ s }}" {% if task.status == s %}selected{% endif %}>{{ s }}</option>
                                        {% endfor %}
                                    </select>
                                </form>
                                <form method="post" action="{{ url_for('delete_task', task_id=task.id) }}" class="delete-form">
                                    <button type="submit" class="delete-btn" title="Delete task">√ó</button>
                                </form>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </section>
                {% endif %}
                <section class="board">
                    {% for status in statuses %}
                    <div class="column" data-status="{{ status }}">
                        <h2 class="column-header">{{ status }}</h2>
                        <ul class="column-cards">
                            {% for task in tasks %}
                            {% if task.status == status and not task.blocked %}
                            {% set due = task.due_date or '' %}
                            {% set is_overdue = due and due < today_iso %}
                            {% set is_due_soon = due and not is_overdue and due <= due_soon_end_iso %}
                            <li class="card card--{{ task.task_type }}{% if task.blocked %} card--blocked{% endif %}{% if is_overdue %} task-overdue{% elif is_due_soon %} task-due-soon{% endif %}" draggable="true" data-task-id="{{ task.id }}" data-in-sprint="{{ 'true' if task.in_sprint else 'false' }}">
                                    <div class="card-body">
                                    <div class="card-body-header">
                                        <label class="card-sprint-checkbox sprint-selection-only" aria-hidden="true" title="Include in sprint">
                                            <input type="checkbox" class="card-in-sprint-cb" data-task-id="{{ task.id }}" {% if task.in_sprint %}checked{% endif %}>
                                            <span class="sprint-cb-label">Sprint</span>
                                        </label>
                                        <button type="button" class="card-collapse-toggle" title="Expand or collapse" aria-expanded="true" aria-label="Collapse card">‚ñæ</button>
                                        {% if task.blocked %}
                                        <span class="blocked-badge blocked-badge--inline" title="{{ task.blocking_reason or 'Blocked' }}">Blocked</span>
                                        {% endif %}
                                        <span class="task-title">{{ task.title }}</span>
                                    </div>
                                    <div class="card-body-detail">
                                        {% if task.blocked and task.blocking_reason %}
                                        <p class="task-blocking-reason-inline"><span class="blocked-reason-label">Reason:</span> {{ task.blocking_reason|e }}</p>
                                        {% endif %}
                                        {% if task.description %}
                                        <p class="task-description">{{ task.description }}</p>
                                        {% endif %}
                                        {% if task.code_snippet %}
                                        <div class="task-code-snippet-wrap">
                                            <pre class="task-code-block"><code>{{ task.code_snippet|e }}</code></pre>
                                        </div>
                                        {% endif %}
                                        <div class="task-meta-row">
                                            <span class="badge badge-type badge-type--{{ task.task_type }}">{{ task.task_type }}</span>
                                            {% if due %}
                                            <span class="task-due-date" title="Due {{ due }}">üìÖ {{ due }}</span>
                                            {% endif %}
                                            {% if task.code_link %}
                                            <a href="#" class="task-code-link" data-code-link="{{ task.code_link|e }}" title="{{ task.code_link }}" aria-label="Open code link">üîó <span class="task-code-link-text">{{ task.code_link }}</span></a>
                                            {% endif %}
                                        </div>
                                        {% set subtasks = task.subtasks or [] %}
                                        {% set done_count = subtasks | selectattr('done') | list | length %}
                                        {% if subtasks %}
                                        <div class="task-progress" title="{{ done_count }}/{{ subtasks|length }} subtasks done">
                                            <div class="task-progress-bar" style="width: {{ (100 * done_count / subtasks|length) if subtasks else 0 }}%"></div>
                                            <span class="task-progress-text">{{ done_count }}/{{ subtasks|length }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="task-subtasks">
                                            <ul class="subtask-list">
                                                {% for st in subtasks %}
                                                <li class="subtask-item {% if st.done %}subtask-done{% endif %}">
                                                    <form method="post" action="{{ url_for('toggle_subtask', task_id=task.id, subtask_id=st.id) }}" class="subtask-toggle-form">
                                                        <button type="submit" class="subtask-checkbox" title="{{ 'Mark incomplete' if st.done else 'Mark done' }}" aria-label="{{ 'Mark incomplete' if st.done else 'Mark done' }}">{{ '‚úì' if st.done else '' }}</button>
                                                    </form>
                                                    <span class="subtask-title">{{ st.title }}</span>
                                                    <form method="post" action="{{ url_for('delete_subtask', task_id=task.id, subtask_id=st.id) }}" class="subtask-delete-form">
                                                        <button type="submit" class="subtask-delete" title="Remove subtask">√ó</button>
                                                    </form>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            <form method="post" action="{{ url_for('add_subtask', task_id=task.id) }}" class="subtask-add-form">
                                                <input type="text" name="title" placeholder="Add subtask‚Ä¶" class="subtask-add-input">
                                                <button type="submit" class="subtask-add-btn">Add</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <form method="post" action="{{ url_for('update_status', task_id=task.id) }}" class="status-form">
                                        <select name="status" onchange="this.form.submit()">
                                            {% for s in statuses %}
                                            <option value="{{ s }}" {% if task.status == s %}selected{% endif %}>{{ s }}</option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                    <form method="post" action="{{ url_for('delete_task', task_id=task.id) }}" class="delete-form">
                                        <button type="submit" class="delete-btn" title="Delete task">√ó</button>
                                    </form>
                                </div>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endfor %}
                </section>
                <script src="{{ url_for('static', filename='subtasks-ajax.js') }}"></script>
                {% else %}
                <p class="empty">No tasks yet. Add one in the left column!</p>
                {% endif %}
            </div>
        </main>

        <aside class="column-right widgets-column">
            <div class="column-right-inner">
                <div class="widget" id="widget-pomodoro">
                    <aside id="pomodoro-box" class="pomodoro-box pomodoro-box--in-layout">
                        <div class="pomodoro-box-header" id="pomodoro-header">
                            <span class="pomodoro-box-title">Pomodoro</span>
                            <button type="button" class="pomodoro-collapse" id="pomodoro-collapse" title="Collapse">‚àí</button>
                            <span class="pomodoro-timer-tab" id="pomodoro-tomato" title="Open timer" aria-hidden="true">Timer</span>
                        </div>
                        <div class="pomodoro-box-body">
                            <div class="pomodoro-settings">
                                <label class="pomodoro-setting">
                                    <span class="pomodoro-label">Focus</span>
                                    <input type="number" id="pomodoro-focus" min="1" max="60" value="25">
                                </label>
                                <label class="pomodoro-setting">
                                    <span class="pomodoro-label">Break</span>
                                    <input type="number" id="pomodoro-break" min="1" max="30" value="5">
                                </label>
                            </div>
                            <div class="pomodoro-display">
                                <span class="pomodoro-phase" id="pomodoro-phase">Focus</span>
                                <span class="pomodoro-time" id="pomodoro-time">25:00</span>
                            </div>
                            <div class="pomodoro-controls">
                                <button type="button" class="pomodoro-btn pomodoro-start" id="pomodoro-start">Start</button>
                                <button type="button" class="pomodoro-btn pomodoro-reset" id="pomodoro-reset">Reset</button>
                            </div>
                            <div class="pomodoro-sessions-row">
                                <span class="pomodoro-sessions" id="pomodoro-sessions">Sessions: 0</span>
                                <button type="button" id="pomodoro-reset-sessions" title="Reset session count to 0">Reset</button>
                            </div>
                        </div>
                    </aside>
                </div>
                <div class="widget widget-quote" id="widget-quote" aria-label="Daily motivational quote">
                    <div class="quote-widget-header">Quote of the day</div>
                    <div class="quote-widget-body">
                        <blockquote class="quote-text" id="quote-text"></blockquote>
                        <cite class="quote-author" id="quote-author"></cite>
                    </div>
                </div>
                <div class="widget widget-pet" id="widget-pet" aria-label="Companion pet">
                    <div class="pet-widget-header">Companion</div>
                    <div class="pet-widget-body">
                        <div class="pet-container" id="pet-container" role="button" tabindex="0" title="Click me!">
                            <span class="pet-message" id="pet-message" aria-live="polite"></span>
                            <div class="pet-character" id="pet-character">
                                <span class="pet-face" aria-hidden="true">üê±</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        </div>
    </div>

    <div id="task-panel-overlay" class="panel-overlay" aria-hidden="true"></div>
    <aside id="task-panel" class="task-panel" aria-hidden="true">
        <div class="panel-header">
            <button type="button" class="panel-close" id="panel-close" title="Close">√ó</button>
        </div>
        <div class="panel-body">
            <form id="panel-edit-form" method="post" action="">
                <label class="panel-label" for="panel-task-title">Title</label>
                <input type="text" name="title" id="panel-task-title" class="panel-title-input" required>
                <label class="panel-label" for="panel-description">Description</label>
                <textarea name="description" id="panel-description" class="panel-description-input" rows="4" placeholder="Add a description‚Ä¶"></textarea>
                <label class="panel-label" for="panel-code-link">Code link</label>
                <div class="panel-code-link-row">
                    <input type="text" name="code_link" id="panel-code-link" class="panel-code-link-input" placeholder="File path, module, or GitHub/GitLab URL‚Ä¶">
                    <button type="button" id="panel-open-code-link" class="panel-open-link-btn" title="Open link in new tab or copy path">Open</button>
                </div>
                <label class="panel-label" for="panel-code-snippet">Code snippet</label>
                <textarea name="code_snippet" id="panel-code-snippet" class="panel-code-snippet-input" rows="6" placeholder="Optional code snippet‚Ä¶"></textarea>
                <div class="panel-blocked-row">
                    <input type="hidden" name="blocked" value="0">
                    <label class="panel-checkbox-label">
                        <input type="checkbox" name="blocked" value="1" id="panel-blocked" class="panel-blocked-cb">
                        <span>Blocked</span>
                    </label>
                    <label class="panel-label" for="panel-blocking-reason">Blocking reason</label>
                    <input type="text" name="blocking_reason" id="panel-blocking-reason" class="panel-blocking-reason-input" placeholder="Why is this task blocked?">
                </div>
                <div class="panel-sprint-row">
                    <input type="hidden" name="in_sprint" value="0">
                    <label class="panel-checkbox-label">
                        <input type="checkbox" name="in_sprint" value="1" id="panel-in-sprint" class="panel-in-sprint-cb">
                        <span>In sprint</span>
                    </label>
                </div>
                <label class="panel-label" for="panel-due-date">Due date</label>
                <input type="date" name="due_date" id="panel-due-date" class="panel-due-input">
                <button type="submit" class="panel-save panel-save--final">Save</button>
            </form>
            <div class="panel-meta">
                <span class="badge badge-type" id="panel-type"></span>
                <span class="panel-status" id="panel-status"></span>
            </div>
        </div>
    </aside>

    <script src="{{ url_for('static', filename='theme-toggle.js') }}"></script>
    <script>
      (function () {
        var sprintModeBtn = document.getElementById("sprint-mode-toggle");
        if (sprintModeBtn) {
          function updateSprintModeState() {
            var active = document.body.classList.contains("sprint-mode-active");
            sprintModeBtn.setAttribute("aria-pressed", active ? "true" : "false");
          }
          updateSprintModeState();
          sprintModeBtn.addEventListener("click", function () {
            document.body.classList.toggle("sprint-mode-active");
            try { localStorage.setItem("taskManagerSprintMode", document.body.classList.contains("sprint-mode-active") ? "1" : "0"); } catch (e) {}
            updateSprintModeState();
          });
        }
        var selectSprintBtn = document.getElementById("sprint-select-toggle");
        if (selectSprintBtn) {
          function updateSelectState() {
            var active = document.body.classList.contains("sprint-selection-mode");
            selectSprintBtn.setAttribute("aria-pressed", active ? "true" : "false");
            document.querySelectorAll(".sprint-selection-only").forEach(function (el) { el.setAttribute("aria-hidden", active ? "false" : "true"); });
          }
          updateSelectState();
          selectSprintBtn.addEventListener("click", function () {
            document.body.classList.toggle("sprint-selection-mode");
            updateSelectState();
          });
        }
        document.addEventListener("change", function (e) {
          if (!e.target || !e.target.classList.contains("card-in-sprint-cb")) return;
          var cb = e.target;
          var taskId = cb.getAttribute("data-task-id");
          if (!taskId) return;
          var inSprint = cb.checked ? "1" : "0";
          var card = cb.closest(".card");
          var formData = new FormData();
          formData.append("in_sprint", inSprint);
          fetch("/task/" + taskId + "/sprint", { method: "POST", body: formData, headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data && data.ok && card) card.setAttribute("data-in-sprint", data.in_sprint ? "true" : "false");
            })
            .catch(function () { cb.checked = !cb.checked; });
        });
      })();
    </script>
    <script>
      (function () {
        var picker = document.getElementById("type-picker");
        var btn = document.getElementById("type-picker-btn");
        var dropdown = document.getElementById("type-picker-dropdown");
        var input = document.getElementById("task_type_input");
        var labelEl = document.getElementById("type-picker-label");
        var swatchEl = document.getElementById("type-picker-swatch");
        if (!picker || !btn || !dropdown || !input) return;
        function close() {
          picker.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
          dropdown.setAttribute("aria-hidden", "true");
        }
        function select(value, label) {
          input.value = value;
          if (labelEl) labelEl.textContent = label;
          if (swatchEl) {
            swatchEl.classList.remove("type-swatch--coding", "type-swatch--debugging", "type-swatch--learning");
            swatchEl.classList.add("type-swatch--" + value);
          }
          close();
        }
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          var isOpen = picker.classList.toggle("open");
          btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
          dropdown.setAttribute("aria-hidden", isOpen ? "false" : "true");
        });
        dropdown.querySelectorAll(".type-picker-option").forEach(function (opt) {
          opt.addEventListener("click", function () {
            select(opt.getAttribute("data-value"), opt.getAttribute("data-label") || opt.textContent.trim());
          });
        });
        document.addEventListener("click", function (e) {
          if (picker && !picker.contains(e.target)) close();
        });
      })();
    </script>
    <script src="{{ url_for('static', filename='kanban-drag.js') }}"></script>
    <script src="{{ url_for('static', filename='pomodoro.js') }}"></script>
    <script src="{{ url_for('static', filename='quote-widget.js') }}"></script>
    <script src="{{ url_for('static', filename='pet-widget.js') }}"></script>
</body>
</html>
